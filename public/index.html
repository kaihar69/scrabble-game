<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scrabble Chef Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Roboto:wght@500;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #eaddcf; --bg-pattern: #dcca ba;
            --board-border: #4e342e; --grid-gap: #111; --field-green: #2e7d32; 
            --tile-color: #f3e5ab; --tile-text: #2c3e50;
            --ui-dark: #2c3e50; --ui-gold: #d4af37; 
            --wood-dark: #5d4037; --wood-light: #8d6e63;
            --header-h: 60px; --footer-h: 130px;
        }

        * { box-sizing: border-box; }

        body { 
            font-family: 'Roboto', sans-serif; 
            background-color: var(--bg-color);
            background-image: 
                radial-gradient(circle at 100% 150%, var(--bg-color) 24%, var(--bg-pattern) 25%, var(--bg-pattern) 28%, var(--bg-color) 29%, var(--bg-color) 36%, var(--bg-pattern) 36%, var(--bg-pattern) 40%, transparent 40%, transparent),
                radial-gradient(circle at 0    150%, var(--bg-color) 24%, var(--bg-pattern) 25%, var(--bg-pattern) 28%, var(--bg-color) 29%, var(--bg-color) 36%, var(--bg-pattern) 36%, var(--bg-pattern) 40%, transparent 40%, transparent),
                radial-gradient(circle at 50%  100%, var(--bg-pattern) 10%, var(--bg-color) 11%, var(--bg-color) 23%, var(--bg-pattern) 24%, var(--bg-pattern) 30%, var(--bg-color) 31%, var(--bg-color) 43%, var(--bg-pattern) 44%, var(--bg-pattern) 50%, transparent 50%, transparent),
                radial-gradient(circle at 100% 50%, var(--bg-pattern) 5%, var(--bg-color) 6%, var(--bg-color) 15%, var(--bg-pattern) 16%, var(--bg-pattern) 20%, var(--bg-color) 21%, var(--bg-color) 30%, var(--bg-pattern) 31%, var(--bg-pattern) 35%, transparent 35%, transparent),
                radial-gradient(circle at 0    50%, var(--bg-pattern) 5%, var(--bg-color) 6%, var(--bg-color) 15%, var(--bg-pattern) 16%, var(--bg-pattern) 20%, var(--bg-color) 21%, var(--bg-color) 30%, var(--bg-pattern) 31%, var(--bg-pattern) 35%, transparent 35%, transparent);
            background-size: 50px 50px;
            color: var(--ui-dark); margin: 0; padding: 0;
            height: 100dvh; width: 100vw; overflow: hidden;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        /* Scoreboard */
        #scoreboard {
            height: var(--header-h); width: 98%; max-width: 600px;
            display: flex; justify-content: space-between; align-items: center;
            background: linear-gradient(to bottom, #34495e, #2c3e50);
            border-bottom: 3px solid var(--ui-gold);
            border-radius: 0 0 15px 15px; padding: 0 25px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); color: #ecf0f1;
            flex-shrink: 0; font-family: 'Cinzel', serif;
        }
        .player-score { display: flex; flex-direction: column; align-items: center; opacity: 0.3; transition: all 0.3s; transform: scale(0.9); }
        
        /* Aktiver Spieler wird hervorgehoben */
        .player-score.active-turn { opacity: 1; color: var(--ui-gold); text-shadow: 0 0 10px rgba(212, 175, 55, 0.5); transform: scale(1.1); font-weight: bold; }
        
        .score-label { font-size: 0.7rem; letter-spacing: 1px; }
        .score-val { font-size: 1.5em; font-weight: bold; }
        #status { font-family: 'Roboto', sans-serif; font-size: 0.9em; color: var(--ui-gold); font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px; }

        /* Board */
        #board-wrapper { flex-grow: 1; width: 100%; display: flex; justify-content: center; align-items: center; overflow: hidden; padding: 10px; }
        #game-board { 
            display: grid; grid-template-columns: repeat(15, 1fr); grid-template-rows: repeat(15, 1fr);
            gap: 2px; background: var(--grid-gap); border: 5px solid var(--board-border); border-radius: 4px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            width: min(95vw, calc(100dvh - 200px)); height: min(95vw, calc(100dvh - 200px));
            aspect-ratio: 1 / 1; 
        }
        .cell { background: var(--field-green); display: flex; align-items: center; justify-content: center; position: relative; cursor: pointer; user-select: none; }
        .cell-label { font-size: clamp(6px, 1.5vh, 10px); font-weight: bold; opacity: 0.7; text-align: center; pointer-events: none; }
        .tw { background-color: #b71c1c; .cell-label { color: #fff; } } .dw { background-color: #f57f17; .cell-label { color: #fff; } } 
        .tl { background-color: #0d47a1; .cell-label { color: #fff; } } .dl { background-color: #0288d1; .cell-label { color: #fff; } } 
        .center { background-color: #f57f17; display: flex; align-items: center; justify-content: center; }
        .star { font-size: 1.5em; color: #fff; line-height: 0; padding-bottom: 5px; }
        
        .tile-look {
            background: linear-gradient(135deg, #fffdf0 0%, #f3e5ab 100%); color: var(--tile-text);
            width: 92%; height: 92%; border-radius: 10%;
            box-shadow: 2px 2px 4px rgba(0,0,0,0.4), inset 0 0 2px rgba(255,255,255,0.5);
            display: flex; justify-content: center; align-items: center; position: relative; z-index: 10;
        }
        .tile-letter { font-size: 68%; font-weight: 900; }
        .tile-score { position: absolute; bottom: 8%; right: 10%; font-size: 32%; font-weight: 600; color: #444; }
        .preview .tile-look { opacity: 0.7; box-shadow: none; border: 2px dotted #333; background: #fff; }

        /* UI & Controls */
        #ui-container { height: var(--footer-h); width: 100%; max-width: 600px; display: flex; flex-direction: column; gap: 15px; padding: 0 15px 15px 15px; justify-content: flex-end; flex-shrink: 0; }
        #rack { 
            background: linear-gradient(to bottom, var(--wood-dark), var(--wood-light)); padding: 8px 10px 4px 10px;
            border-radius: 10px 10px 4px 4px; display: flex; justify-content: center; gap: 4px; height: 65px; 
            box-shadow: inset 0 4px 8px rgba(0,0,0,0.6), 0 5px 10px rgba(0,0,0,0.3); position: relative;
        }
        #rack::after { content: ''; position: absolute; bottom: 0; left:0; right:0; height: 5px; background: var(--wood-dark); border-radius: 0 0 4px 4px; box-shadow: inset 0 -1px 2px rgba(0,0,0,0.5); }
        .hand-slot { height: 90%; aspect-ratio: 1/1; display: flex; align-items: flex-end; justify-content: center; cursor: pointer; transition: transform 0.2s; z-index: 2; }
        .hand-slot.selected { transform: translateY(-15px); }

        #controls { display: flex; justify-content: center; gap: 20px; height: 50px; }
        button { 
            flex: 1; max-width: 180px; font-size: 1rem; font-family: 'Roboto', sans-serif;
            border: none; border-radius: 50px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; cursor: pointer;
            touch-action: manipulation; transition: all 0.2s; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); position: relative; overflow: hidden;
        }
        button::after { content: ''; position: absolute; top:0; left:0; width: 100%; height: 50%; background: linear-gradient(to bottom, rgba(255,255,255,0.3), transparent); }
        
        .btn-submit { background: linear-gradient(to bottom, #2ecc71, #27ae60); }
        .btn-submit:active { transform: translateY(2px); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .btn-reset { background: linear-gradient(to bottom, #e74c3c, #c0392b); }
        .btn-reset:active { transform: translateY(2px); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* Deaktivierte Buttons */
        button:disabled {
            background: #95a5a6; /* Grau */
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none;
            opacity: 0.6;
        }
    </style>
</head>
<body>
    
    <div id="scoreboard">
        <div class="player-score" id="p1-score">
            <span class="score-label">SPIELER 1</span>
            <span class="score-val" id="score-0">0</span>
        </div>
        <div id="status">Lade...</div>
        <div class="player-score" id="p2-score">
            <span class="score-label">SPIELER 2</span>
            <span class="score-val" id="score-1">0</span>
        </div>
    </div>

    <div id="board-wrapper">
        <div id="game-board"></div>
    </div>

    <div id="ui-container">
        <div id="rack"></div>
        <div id="controls">
            <button class="btn-reset" id="btn-reset" onclick="resetTurn()">Zurück</button>
            <button class="btn-submit" id="btn-submit" onclick="submitTurn()">Legen</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const boardElement = document.getElementById('game-board');
        const rackElement = document.getElementById('rack');
        const statusElement = document.getElementById('status');
        const btnSubmit = document.getElementById('btn-submit');
        const btnReset = document.getElementById('btn-reset');
        
        let selectedTile = null; 
        let myHand = []; 
        let currentBoard = Array(225).fill(null);
        let currentTurnMoves = []; 
        
        let myPlayerIndex = -1;
        let activePlayerIndex = 0; // Wer ist dran?

        const LETTER_SCORES = {
            "A": 1, "B": 3, "C": 4, "D": 1, "E": 1, "F": 4, "G": 2, "H": 2, 
            "I": 1, "J": 6, "K": 4, "L": 2, "M": 3, "N": 1, "O": 2, "P": 4, 
            "Q": 10, "R": 1, "S": 1, "T": 1, "U": 1, "V": 6, "W": 3, "X": 8, 
            "Y": 10, "Z": 3
        };

        function getCellType(x, y) {
            const k = x + "," + y;
            if (k === "7,7") return "center";
            if ((x===0||x===7||x===14) && (y===0||y===7||y===14) && k!=="7,7") return "tw"; 
            if (x===y || x+y===14) { if(x>=1 && x<=4) return "dw"; if(x>=10 && x<=13) return "dw"; }
            if ((x===5||x===9) && (y===1||y===5||y===9||y===13)) return "tl";
            if ((y===5||y===9) && (x===1||x===5||x===9||x===13)) return "tl";
            if ((x===3||x===11) && (y===0||y===7||y===14)) return "dl";
            if ((y===3||y===11) && (x===0||x===7||x===14)) return "dl";
            if ((x===2||x===6||x===8||x===12) && (y===6||y===8)) return "dl";
            if ((y===2||y===6||y===8||y===12) && (x===6||x===8)) return "dl";
            return "";
        }

        function createTileHTML(letter) {
            const score = LETTER_SCORES[letter] !== undefined ? LETTER_SCORES[letter] : 0;
            return `<div class="tile-look"><span class="tile-letter">${letter}</span><span class="tile-score">${score}</span></div>`;
        }

        for (let i = 0; i < 225; i++) {
            const cell = document.createElement('div');
            cell.classList.add('cell');
            const x = i % 15; const y = Math.floor(i / 15);
            const type = getCellType(x, y);
            if(type) cell.classList.add(type);
            
            let labelText = "";
            if(type === 'tw') labelText = "3W"; else if(type === 'dw') labelText = "2W";
            else if(type === 'tl') labelText = "3B"; else if(type === 'dl') labelText = "2B";
            
            if (type === 'center') cell.innerHTML = '<span class="star">★</span>';
            else if (labelText) cell.innerHTML = `<span class="cell-label">${labelText}</span>`;

            cell.dataset.index = i;
            cell.addEventListener('click', () => {
                // Nur klicken, wenn man dran ist!
                if (myPlayerIndex !== activePlayerIndex) return;

                const isOccupiedServer = currentBoard[i] !== null;
                const isOccupiedLocal = currentTurnMoves.find(m => m.index === i);
                if (!isOccupiedServer && !isOccupiedLocal && selectedTile) {
                    cell.innerHTML = createTileHTML(selectedTile.letter);
                    cell.classList.add('preview');
                    currentTurnMoves.push({ index: i, letter: selectedTile.letter });
                    myHand.splice(selectedTile.handIndex, 1);
                    selectedTile = null;
                    renderHand();
                }
            });
            boardElement.appendChild(cell);
        }

        function renderHand() {
            rackElement.innerHTML = '';
            myHand.forEach((letter, idx) => {
                const slot = document.createElement('div');
                slot.classList.add('hand-slot');
                slot.innerHTML = createTileHTML(letter);
                slot.addEventListener('click', () => {
                    if (myPlayerIndex !== activePlayerIndex) return; // Nicht dran
                    document.querySelectorAll('.hand-slot').forEach(t => t.classList.remove('selected'));
                    slot.classList.add('selected');
                    selectedTile = { letter: letter, handIndex: idx };
                });
                rackElement.appendChild(slot);
            });
        }

        function resetTurn() {
            currentTurnMoves.forEach(move => myHand.push(move.letter));
            currentTurnMoves = [];
            renderHand();
            updateBoardView(); 
        }

        function submitTurn() {
            if (currentTurnMoves.length === 0) return;
            socket.emit('submit-turn', currentTurnMoves);
        }

        function updateBoardView() {
            const cells = document.querySelectorAll('.cell');
            cells.forEach((cell, i) => {
                const x = i % 15; const y = Math.floor(i / 15);
                const type = getCellType(x, y);
                cell.className = 'cell'; 
                if(type) cell.classList.add(type);

                if (currentBoard[i]) {
                    cell.innerHTML = createTileHTML(currentBoard[i]);
                } else {
                    let labelText = "";
                    if(type === 'tw') labelText = "3W"; else if(type === 'dw') labelText = "2W";
                    else if(type === 'tl') labelText = "3B"; else if(type === 'dl') labelText = "2B";
                    if (type === 'center') cell.innerHTML = '<span class="star">★</span>';
                    else if (labelText) cell.innerHTML = `<span class="cell-label">${labelText}</span>`;
                    else cell.innerHTML = '';
                }
            });
        }

        function updateTurnState() {
            const p1 = document.getElementById('p1-score');
            const p2 = document.getElementById('p2-score');
            
            // Scoreboard Highlights
            p1.classList.remove('active-turn');
            p2.classList.remove('active-turn');
            if(activePlayerIndex === 0) p1.classList.add('active-turn');
            if(activePlayerIndex === 1) p2.classList.add('active-turn');

            // Bin ICH dran?
            const isMyTurn = (myPlayerIndex === activePlayerIndex);
            
            if (isMyTurn) {
                statusElement.innerText = "DU BIST DRAN";
                statusElement.style.color = "#2ecc71"; // Grün
                btnSubmit.disabled = false;
                btnReset.disabled = false;
                rackElement.style.opacity = "1";
            } else {
                statusElement.innerText = "GEGNER IST DRAN";
                statusElement.style.color = "#e74c3c"; // Rot
                btnSubmit.disabled = true;
                btnReset.disabled = true;
                rackElement.style.opacity = "0.5"; // Hand leicht ausblenden
            }
        }

        socket.on('player-assignment', (data) => {
            myPlayerIndex = data.playerIndex;
            // Wir aktualisieren hier noch nicht den Turn, warten auf 'update-turn'
        });

        socket.on('update-turn', (idx) => {
            activePlayerIndex = idx;
            updateTurnState();
        });

        socket.on('update-hand', (newHand) => { myHand = newHand; renderHand(); });
        socket.on('update-board', (boardData) => { currentBoard = boardData; currentTurnMoves = []; updateBoardView(); });
        socket.on('update-scores', (playersData) => {
            const score0 = document.getElementById('score-0');
            const score1 = document.getElementById('score-1');
            if(playersData[0]) score0.innerText = playersData[0].score;
            if(playersData[1]) score1.innerText = playersData[1].score;
        });
        socket.on('move-error', (msg) => {
            const oldT = statusElement.innerText;
            statusElement.innerText = "⚠️ " + msg;
            setTimeout(() => { updateTurnState(); }, 2500);
            resetTurn(); 
        });
    </script>
</body>
</html>
