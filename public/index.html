<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scrabble Chef Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@500;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1a1a1a;
            --board-border: #4e342e; 
            --grid-gap: #111; 
            --field-green: #2e7d32; 
            --tile-color: #f3e5ab; 
            --tile-text: #2c3e50;
        }

        * { box-sizing: border-box; }

        body { 
            font-family: 'Roboto', sans-serif; 
            background: var(--bg-color); 
            color: #ecf0f1; 
            margin: 0; 
            padding: 5px; /* Minimaler Rand */
            
            /* Der Trick für "Kein Scrollen": */
            height: 100dvh; /* Dynamic Viewport Height */
            width: 100vw;
            overflow: hidden; /* Scrollbalken verbieten */
            
            display: flex; 
            flex-direction: column; 
            justify-content: space-between; 
            align-items: center;
        }

        /* --- Scoreboard (Oben, feste Größe aber flexibel) --- */
        #scoreboard {
            flex: 0 0 auto; /* Darf nicht schrumpfen/wachsen */
            display: flex; justify-content: space-between; align-items: center;
            width: 100%; max-width: 600px;
            background: #263238; 
            padding: 8px 15px;
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            font-size: 0.9rem;
            z-index: 20;
        }
        .player-score { display: flex; flex-direction: column; align-items: center; opacity: 0.7; }
        .player-score.active { opacity: 1; color: #fff; }
        .score-val { font-size: 1.2em; color: #f1c40f; font-weight: bold; }
        #status { font-size: 0.9em; color: #ffb300; font-weight: bold; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 40%; }

        /* --- Brett-Container (Mitte, flexibel) --- */
        #board-wrapper {
            flex: 1 1 auto; /* Nimmt den restlichen Platz */
            display: flex; 
            justify-content: center; 
            align-items: center;
            width: 100%;
            overflow: hidden; /* Wichtig */
            padding: 5px 0; /* Etwas Luft oben/unten */
        }

        #game-board { 
            display: grid; 
            grid-template-columns: repeat(15, 1fr); 
            grid-template-rows: repeat(15, 1fr);
            gap: 2px; 
            background: var(--grid-gap); 
            border: 2px solid var(--board-border);
            
            /* Das Herzstück der Größenberechnung: */
            /* Es versucht so groß wie möglich zu sein, aber... */
            width: 100%;
            height: 100%;
            /* ...es darf nie das Seitenverhältnis brechen */
            aspect-ratio: 1 / 1;
            /* ...und es darf nie über den Container hinausgehen */
            max-height: 100%; 
            max-width: 100%;
            
            /* Fallback für Landscape auf Handy: */
            object-fit: contain;
        }

        .cell { 
            background: var(--field-green); 
            display: flex; align-items: center; justify-content: center; 
            position: relative; cursor: pointer; user-select: none;
        }
        
        .cell-label {
            font-size: clamp(6px, 1.5vh, 10px); /* Responsive Schrift */
            font-weight: bold; opacity: 0.7; text-align: center;
            pointer-events: none;
        }

        /* Farben Spezialfelder */
        .tw { background-color: #b71c1c; .cell-label { color: #fff; } } 
        .dw { background-color: #f57f17; .cell-label { color: #fff; } } 
        .tl { background-color: #0d47a1; .cell-label { color: #fff; } } 
        .dl { background-color: #0288d1; .cell-label { color: #fff; } } 
        .center { background-color: #f57f17; display: flex; align-items: center; justify-content: center; }
        .star { font-size: 1.5em; color: #fff; line-height: 0; padding-bottom: 5px; }

        /* --- Spielstein --- */
        .tile-look {
            background: linear-gradient(135deg, #fff8e1 0%, #f3e5ab 100%);
            color: var(--tile-text);
            width: 92%; height: 92%;
            border-radius: 15%; /* Etwas runder */
            box-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            display: flex; justify-content: center; align-items: center;
            position: relative; z-index: 10;
        }
        
        .tile-letter {
            /* Schriftgröße passt sich der Kachel an */
            font-size: 65%; 
            font-weight: 900;
        }

        .tile-score {
            position: absolute; bottom: 8%; right: 10%;
            font-size: 30%;
            font-weight: 600; color: #444;
        }
        
        .preview .tile-look { opacity: 0.6; box-shadow: none; border: 1px dashed #333; }

        /* --- UI Container (Unten, fest) --- */
        #ui-container {
            flex: 0 0 auto; /* Feste Höhe */
            width: 100%; max-width: 600px; 
            display: flex; flex-direction: column; gap: 8px;
            padding-bottom: 5px; /* Abstand zum Rand unten */
        }

        #rack { 
            background: #263238; padding: 5px; border-radius: 8px; 
            display: flex; justify-content: center; gap: 4px;
            height: 12vh; /* Dynamische Höhe relativ zum Screen */
            max-height: 60px; /* Aber nicht riesig werden am PC */
            min-height: 45px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
        }
        
        .hand-slot {
            aspect-ratio: 1/1; /* Quadratisch bleiben */
            height: 100%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.1s;
        }
        .hand-slot.selected { transform: translateY(-10%); border-bottom: 3px solid #f1c40f; }

        #controls { display: flex; justify-content: space-between; gap: 10px; height: 45px; }
        
        button { 
            flex: 1; 
            font-size: 1rem; 
            border: none; border-radius: 4px; 
            font-weight: bold; text-transform: uppercase; letter-spacing: 1px;
            cursor: pointer;
            /* Touch-freundlich */
            touch-action: manipulation;
        }
        .btn-submit { background-color: #388e3c; color: white; box-shadow: 0 3px 0 #1b5e20; }
        .btn-submit:active { transform: translateY(2px); box-shadow: none; }
        .btn-reset { background-color: #d32f2f; color: white; box-shadow: 0 3px 0 #8c1b1b; }
        .btn-reset:active { transform: translateY(2px); box-shadow: none; }

        /* Media Query für sehr kleine Bildschirme (iPhone SE etc.) */
        @media (max-height: 600px) {
            #controls { height: 35px; }
            #scoreboard { padding: 4px 10px; font-size: 0.8em; }
            button { font-size: 0.8rem; }
        }
    </style>
</head>
<body>
    
    <div id="scoreboard">
        <div class="player-score" id="p1-score">
            <span>P1</span>
            <span class="score-val" id="score-0">0</span>
        </div>
        <div id="status">Lade...</div>
        <div class="player-score" id="p2-score">
            <span>P2</span>
            <span class="score-val" id="score-1">0</span>
        </div>
    </div>

    <div id="board-wrapper">
        <div id="game-board"></div>
    </div>

    <div id="ui-container">
        <div id="rack"></div>
        <div id="controls">
            <button class="btn-reset" onclick="resetTurn()">X</button>
            <button class="btn-submit" onclick="submitTurn()">LEGEN</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const boardElement = document.getElementById('game-board');
        const rackElement = document.getElementById('rack');
        const statusElement = document.getElementById('status');
        
        let selectedTile = null; 
        let myHand = []; 
        let currentBoard = Array(225).fill(null);
        let currentTurnMoves = []; 

        const LETTER_SCORES = {
            "A": 1, "B": 3, "C": 4, "D": 1, "E": 1, "F": 4, "G": 2, "H": 2, 
            "I": 1, "J": 6, "K": 4, "L": 2, "M": 3, "N": 1, "O": 2, "P": 4, 
            "Q": 10, "R": 1, "S": 1, "T": 1, "U": 1, "V": 6, "W": 3, "X": 8, 
            "Y": 10, "Z": 3
        };

        function getCellType(x, y) {
            const k = x + "," + y;
            if (k === "7,7") return "center";
            if ((x===0||x===7||x===14) && (y===0||y===7||y===14) && k!=="7,7") return "tw"; 
            if (x===y || x+y===14) { if(x>=1 && x<=4) return "dw"; if(x>=10 && x<=13) return "dw"; }
            if ((x===5||x===9) && (y===1||y===5||y===9||y===13)) return "tl";
            if ((y===5||y===9) && (x===1||x===5||x===9||x===13)) return "tl";
            if ((x===3||x===11) && (y===0||y===7||y===14)) return "dl";
            if ((y===3||y===11) && (x===0||x===7||x===14)) return "dl";
            if ((x===2||x===6||x===8||x===12) && (y===6||y===8)) return "dl";
            if ((y===2||y===6||y===8||y===12) && (x===6||x===8)) return "dl";
            return "";
        }

        function createTileHTML(letter) {
            const score = LETTER_SCORES[letter] !== undefined ? LETTER_SCORES[letter] : 0;
            // Verwendung von Container-Queries-ähnlicher Schriftgröße (Prozent)
            return `<div class="tile-look"><span class="tile-letter">${letter}</span><span class="tile-score">${score}</span></div>`;
        }

        // Brett initialisieren
        for (let i = 0; i < 225; i++) {
            const cell = document.createElement('div');
            cell.classList.add('cell');
            const x = i % 15; const y = Math.floor(i / 15);
            const type = getCellType(x, y);
            
            if(type) cell.classList.add(type);
            
            let labelText = "";
            if(type === 'tw') labelText = "3W"; else if(type === 'dw') labelText = "2W";
            else if(type === 'tl') labelText = "3B"; else if(type === 'dl') labelText = "2B";
            
            if (type === 'center') cell.innerHTML = '<span class="star">★</span>';
            else if (labelText) cell.innerHTML = `<span class="cell-label">${labelText}</span>`;

            cell.dataset.index = i;
            
            cell.addEventListener('click', () => {
                const isOccupiedServer = currentBoard[i] !== null;
                const isOccupiedLocal = currentTurnMoves.find(m => m.index === i);

                if (!isOccupiedServer && !isOccupiedLocal && selectedTile) {
                    cell.innerHTML = createTileHTML(selectedTile.letter);
                    cell.classList.add('preview');
                    currentTurnMoves.push({ index: i, letter: selectedTile.letter });
                    myHand.splice(selectedTile.handIndex, 1);
                    selectedTile = null;
                    renderHand();
                }
            });
            boardElement.appendChild(cell);
        }

        function renderHand() {
            rackElement.innerHTML = '';
            myHand.forEach((letter, idx) => {
                const slot = document.createElement('div');
                slot.classList.add('hand-slot');
                slot.innerHTML = createTileHTML(letter);
                slot.addEventListener('click', () => {
                    document.querySelectorAll('.hand-slot').forEach(t => t.classList.remove('selected'));
                    slot.classList.add('selected');
                    selectedTile = { letter: letter, handIndex: idx };
                });
                rackElement.appendChild(slot);
            });
        }

        function resetTurn() {
            currentTurnMoves.forEach(move => myHand.push(move.letter));
            currentTurnMoves = [];
            renderHand();
            updateBoardView(); 
        }

        function submitTurn() {
            if (currentTurnMoves.length === 0) return;
            socket.emit('submit-turn', currentTurnMoves);
        }

        function updateBoardView() {
            const cells = document.querySelectorAll('.cell');
            cells.forEach((cell, i) => {
                const x = i % 15; const y = Math.floor(i / 15);
                const type = getCellType(x, y);
                cell.className = 'cell'; 
                if(type) cell.classList.add(type);

                if (currentBoard[i]) {
                    cell.innerHTML = createTileHTML(currentBoard[i]);
                } else {
                    let labelText = "";
                    if(type === 'tw') labelText = "3W"; else if(type === 'dw') labelText = "2W";
                    else if(type === 'tl') labelText = "3B"; else if(type === 'dl') labelText = "2B";
                    
                    if (type === 'center') cell.innerHTML = '<span class="star">★</span>';
                    else if (labelText) cell.innerHTML = `<span class="cell-label">${labelText}</span>`;
                    else cell.innerHTML = '';
                }
            });
        }

        // --- Socket Events ---
        socket.on('player-assignment', (data) => {
            const p1 = document.getElementById('p1-score');
            const p2 = document.getElementById('p2-score');
            if(data.playerIndex === 0) { p1.classList.add('active'); p1.style.borderBottom = "2px solid #f1c40f"; }
            if(data.playerIndex === 1) { p2.classList.add('active'); p2.style.borderBottom = "2px solid #f1c40f"; }
            statusElement.innerText = `Du bist P${data.playerIndex + 1}`;
        });

        socket.on('update-hand', (newHand) => { myHand = newHand; renderHand(); });
        socket.on('update-board', (boardData) => { currentBoard = boardData; currentTurnMoves = []; updateBoardView(); });
        
        socket.on('update-scores', (playersData) => {
            const score0 = document.getElementById('score-0');
            const score1 = document.getElementById('score-1');
            if(playersData[0]) score0.innerText = playersData[0].score;
            if(playersData[1]) score1.innerText = playersData[1].score;
        });

        socket.on('move-error', (msg) => {
            const oldT = statusElement.innerText;
            statusElement.innerText = "⚠️ " + msg;
            statusElement.style.color = "#ff5252";
            setTimeout(() => { statusElement.innerText = oldT; statusElement.style.color = "#ffb300"; }, 2500);
            resetTurn(); 
        });
    </script>
</body>
</html>
