<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scrabble Chef Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #202020;
            --board-green: #27ae60;
            --board-gap: #1e8449;
            --tile-wood: #f5deb3;
            --tile-shadow: #c5a065;
        }

        body { 
            font-family: 'Roboto', sans-serif; 
            display: flex; flex-direction: column; align-items: center; 
            background: var(--bg-color); 
            color: #ecf0f1; 
            margin: 0; padding: 20px; 
        }
        
        h1 { margin-bottom: 5px; font-weight: 300; letter-spacing: 2px; text-transform: uppercase; }

        /* Das Brett - Modern & Grün */
        #game-container {
            padding: 15px;
            background: #2e4053;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            margin-top: 20px;
        }

        #game-board { 
            display: grid; 
            grid-template-columns: repeat(15, 1fr); 
            gap: 3px; 
            background: var(--board-gap); /* Die Linienfarbe */
            border: 5px solid var(--board-gap);
            border-radius: 4px;
            width: 100%;
            max-width: 650px;
            aspect-ratio: 1 / 1;
        }

        .cell { 
            background: var(--board-green); 
            display: flex; align-items: center; justify-content: center; 
            font-weight: 700; font-size: clamp(8px, 2vw, 14px); 
            color: rgba(255,255,255,0.3); /* Dezentere Schrift auf leeren Feldern */
            cursor: pointer; user-select: none;
            position: relative;
            border-radius: 2px;
            transition: background 0.2s;
        }
        
        .cell:hover { filter: brightness(1.1); }

        /* Spezialfelder - Modern Pastell */
        .tw { background-color: #c0392b; color: #fff; } /* Triple Word (Dunkelrot) */
        .dw { background-color: #e67e22; color: #fff; } /* Double Word (Orange) */
        .tl { background-color: #2980b9; color: #fff; } /* Triple Letter (Blau) */
        .dl { background-color: #8e44ad; color: #fff; } /* Double Letter (Lila) */
        .center { background-color: #e67e22; color: #fff; font-size: 20px;}

        /* Der Spielstein (auf dem Brett und in der Hand) */
        .tile-look {
            background-color: var(--tile-wood);
            color: #3e2723;
            box-shadow: 0 3px 0 var(--tile-shadow);
            border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
            width: 90%; height: 90%;
            font-size: clamp(12px, 2.5vw, 22px);
            z-index: 10;
        }
        
        .preview .tile-look {
            background-color: #fff; /* Vorschau ist weiß */
            color: var(--board-green);
            box-shadow: 0 3px 0 #ccc;
            opacity: 0.9;
        }

        /* Controls */
        #controls { margin-top: 25px; display: flex; gap: 15px; }
        button { 
            padding: 12px 30px; font-size: 16px; cursor: pointer; border: none; border-radius: 50px; 
            font-weight: bold; transition: transform 0.1s, filter 0.2s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        button:active { transform: translateY(2px); }
        .btn-submit { background-color: #27ae60; color: white; } /* Grün */
        .btn-reset { background-color: #7f8c8d; color: white; } /* Grau */

        /* Die Hand (Rack) */
        #rack { 
            margin-top: 25px; display: flex; gap: 10px; 
            background: #2e4053; padding: 15px 25px; border-radius: 10px; 
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);
            flex-wrap: wrap; justify-content: center;
            min-height: 50px;
        }
        
        .hand-tile { 
            width: 45px; height: 45px; 
            cursor: pointer; 
            transition: transform 0.2s;
        }
        .hand-tile.selected { transform: translateY(-8px); filter: brightness(1.1); }
        
        #status { margin-top: 10px; font-size: 1.1em; height: 1.5em; text-align: center; color: #f1c40f; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Scrabble <span style="color:#27ae60; font-size:0.8em">Chef Edition</span></h1>
    <div id="status">Verbinde...</div>
    
    <div id="game-container">
        <div id="game-board"></div>
    </div>

    <div id="rack"></div>

    <div id="controls">
        <button class="btn-reset" onclick="resetTurn()">Löschen</button>
        <button class="btn-submit" onclick="submitTurn()">LEGEN</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const boardElement = document.getElementById('game-board');
        const rackElement = document.getElementById('rack');
        const statusElement = document.getElementById('status');
        
        let selectedTile = null; 
        let myHand = []; 
        let currentBoard = Array(225).fill(null);
        let currentTurnMoves = []; 

        function getCellType(x, y) {
            const k = x + "," + y;
            if (k === "7,7") return "center";
            if ((x===0||x===7||x===14) && (y===0||y===7||y===14) && k!=="7,7") return "tw"; 
            if (x===y || x+y===14) return "dw";
            // Einfaches Muster für Triple Letter / Double Letter damit es gefüllt aussieht
            if ((x===1||x===5||x===9||x===13)&&(y===1||y===5||y===9||y===13)) return "tl"; 
            if ((x===3||x===11)&&(y===0||y===7||y===14)) return "dl";
            if ((y===3||y===11)&&(x===0||x===7||x===14)) return "dl";
            return "";
        }

        // Brett aufbauen
        for (let i = 0; i < 225; i++) {
            const cell = document.createElement('div');
            cell.classList.add('cell');
            const x = i % 15; const y = Math.floor(i / 15);
            const type = getCellType(x, y);
            if(type) cell.classList.add(type);
            
            // Labels (nur wenn kein Stein drauf liegt)
            const labelSpan = document.createElement('span');
            if(type === 'tw') labelSpan.innerText = "3W";
            else if(type === 'dw') labelSpan.innerText = "2W";
            else if(type === 'tl') labelSpan.innerText = "3B";
            else if(type === 'dl') labelSpan.innerText = "2B";
            else if(type === 'center') labelSpan.innerText = "★";
            cell.appendChild(labelSpan);
            
            cell.dataset.index = i;
            
            cell.addEventListener('click', () => {
                const isOccupiedServer = currentBoard[i] !== null;
                const isOccupiedLocal = currentTurnMoves.find(m => m.index === i);

                if (!isOccupiedServer && !isOccupiedLocal && selectedTile) {
                    // Inhalt leeren (Label entfernen)
                    cell.innerHTML = '';
                    
                    // Schönen Stein rendern
                    const tileDiv = document.createElement('div');
                    tileDiv.classList.add('tile-look');
                    tileDiv.innerText = selectedTile.letter;
                    cell.appendChild(tileDiv);
                    cell.classList.add('preview'); // Markierung für "noch nicht fest"
                    
                    currentTurnMoves.push({ index: i, letter: selectedTile.letter });
                    myHand.splice(selectedTile.handIndex, 1);
                    selectedTile = null;
                    renderHand();
                }
            });
            boardElement.appendChild(cell);
        }

        function renderHand() {
            rackElement.innerHTML = '';
            myHand.forEach((letter, idx) => {
                const tileWrapper = document.createElement('div');
                tileWrapper.classList.add('hand-tile', 'tile-look');
                tileWrapper.innerText = letter;
                
                tileWrapper.addEventListener('click', () => {
                    document.querySelectorAll('.hand-tile').forEach(t => t.classList.remove('selected'));
                    tileWrapper.classList.add('selected');
                    selectedTile = { letter: letter, handIndex: idx };
                });
                rackElement.appendChild(tileWrapper);
            });
        }

        function resetTurn() {
            currentTurnMoves.forEach(move => myHand.push(move.letter));
            currentTurnMoves = [];
            renderHand();
            updateBoardView(); 
        }

        function submitTurn() {
            if (currentTurnMoves.length === 0) return;
            socket.emit('submit-turn', currentTurnMoves);
        }

        function updateBoardView() {
            const cells = document.querySelectorAll('.cell');
            cells.forEach((cell, i) => {
                const x = i % 15; const y = Math.floor(i / 15);
                const type = getCellType(x, y);
                
                // Inhalt zurücksetzen
                cell.innerHTML = '';
                cell.className = 'cell'; // Klassen resetten
                if(type) cell.classList.add(type);

                if (currentBoard[i]) {
                    // Fester Stein vom Server
                    const tileDiv = document.createElement('div');
                    tileDiv.classList.add('tile-look');
                    tileDiv.innerText = currentBoard[i];
                    cell.appendChild(tileDiv);
                } else {
                    // Label wiederherstellen
                    const labelSpan = document.createElement('span');
                    if(type === 'tw') labelSpan.innerText = "3W";
                    else if(type === 'dw') labelSpan.innerText = "2W";
                    else if(type === 'tl') labelSpan.innerText = "3B";
                    else if(type === 'dl') labelSpan.innerText = "2B";
                    else if(type === 'center') labelSpan.innerText = "★";
                    cell.appendChild(labelSpan);
                }
            });
        }

        // --- Socket Logik ---
        socket.on('player-assignment', (data) => statusElement.innerText = `Du bist Spieler ${data.playerIndex + 1}`);
        socket.on('update-hand', (newHand) => { myHand = newHand; renderHand(); });
        
        socket.on('move-error', (msg) => {
            const oldText = statusElement.innerText;
            statusElement.innerText = "⚠️ " + msg;
            statusElement.style.color = "#e74c3c";
            setTimeout(() => {
                statusElement.innerText = oldText;
                statusElement.style.color = "#f1c40f";
            }, 3000);
            resetTurn(); 
        });

        socket.on('update-board', (boardData) => {
            currentBoard = boardData;
            currentTurnMoves = [];
            updateBoardView();
        });
    </script>
</body>
</html>
