<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scrabble Chef Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Roboto:wght@500;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #eaddcf; 
            --bg-pattern: #dccaba;
            --board-border: #4e342e; --grid-gap: #111; --field-green: #2e7d32; 
            --tile-color: #f3e5ab; --tile-text: #2c3e50;
            --ui-dark: #2c3e50; --ui-gold: #d4af37; 
            --wood-dark: #5d4037; --wood-light: #8d6e63;
            --header-h: 80px; --footer-h: 140px;
        }

        * { box-sizing: border-box; }

        body { 
            font-family: 'Roboto', sans-serif; 
            background-color: var(--bg-color);
            background-image: radial-gradient(var(--bg-pattern) 1px, transparent 1px);
            background-size: 20px 20px;
            color: var(--ui-dark); margin: 0; padding: 0;
            height: 100dvh; width: 100vw; overflow: hidden;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* --- LOGIN --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        #login-box {
            background: var(--bg-color); padding: 30px; border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5); text-align: center; border: 4px solid var(--ui-gold);
            width: 90%; max-width: 400px; display: flex; flex-direction: column; gap: 15px;
        }
        #login-box h2 { font-family: 'Cinzel', serif; margin: 0 0 10px 0; color: var(--wood-dark); }
        .inp { padding: 12px; font-size: 1.1rem; border: 2px solid var(--wood-light); border-radius: 5px; text-align: center; font-weight: bold; }
        
        .login-buttons { display: flex; gap: 10px; }
        #btn-start { flex: 2; padding: 15px; background: linear-gradient(to bottom, #27ae60, #219150); color: white; border: none; border-radius: 5px; cursor: pointer; text-transform: uppercase; font-weight: bold;}
        #btn-training { flex: 1; padding: 15px; background: linear-gradient(to bottom, #2980b9, #2471a3); color: white; border: none; border-radius: 5px; cursor: pointer; text-transform: uppercase; font-weight: bold;}

        /* --- SCOREBOARD --- */
        #scoreboard {
            height: var(--header-h); width: 98%; max-width: 700px;
            display: flex; justify-content: center; align-items: flex-end; 
            gap: 15px;
            background: linear-gradient(to bottom, #34495e, #2c3e50);
            border-bottom: 3px solid var(--ui-gold); border-radius: 0 0 15px 15px; padding: 0 10px 10px 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); color: #ecf0f1; flex-shrink: 0; position: relative; z-index: 50; 
        }
        
        #room-display {
            position: absolute; top: 5px; left: 50%; transform: translateX(-50%);
            font-family: 'Cinzel', serif; font-size: 0.8rem; color: var(--ui-gold);
            letter-spacing: 2px; opacity: 0.8; pointer-events: none;
        }

        .player-badge { display: flex; flex-direction: column; align-items: center; opacity: 0.5; transition: all 0.3s; width: 22%; }
        .player-badge.active-turn { opacity: 1; color: var(--ui-gold); text-shadow: 0 0 10px rgba(212, 175, 55, 0.5); transform: scale(1.05); font-weight: bold; }
        .p-name { font-size: 0.6rem; text-transform: uppercase; max-width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .p-score { font-size: 1.2em; font-weight: 900; font-family: 'Cinzel', serif;}
        
        /* Buttons im Header */
        #btn-add-bot { position: absolute; right: 10px; bottom: 15px; padding: 2px 6px; font-size: 0.6rem; background: #34495e; color: #7f8c8d; border: 1px solid #555; border-radius: 4px; cursor: pointer; display: none; }
        
        #btn-rules { 
            position: absolute; left: 10px; top: 10px; width: 24px; height: 24px; 
            background: rgba(255,255,255,0.1); color: #ccc; border: 1px solid #777; border-radius: 50%; 
            cursor: pointer; font-size: 14px; font-weight: bold; font-family: 'Cinzel', serif; 
            display: flex; align-items: center; justify-content: center; 
        }

        /* NEU: Musik Button (oben rechts) */
        #btn-music { 
            position: absolute; right: 10px; top: 10px; width: 24px; height: 24px; 
            background: rgba(255,255,255,0.1); color: #ccc; border: 1px solid #777; border-radius: 50%; 
            cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; 
        }
        #btn-music:hover { background: var(--ui-gold); color: var(--ui-dark); }

        /* --- BOARD --- */
        #board-wrapper { flex-grow: 1; width: 100%; display: flex; justify-content: center; align-items: center; overflow: hidden; padding: 5px; margin-top: 20px; }
        #game-board { 
            display: grid; grid-template-columns: repeat(15, 1fr); grid-template-rows: repeat(15, 1fr);
            gap: 2px; background: var(--grid-gap); border: 5px solid var(--board-border); border-radius: 4px;
            width: min(96vw, calc(100dvh - 240px)); height: min(96vw, calc(100dvh - 240px));
            aspect-ratio: 1 / 1; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .cell { 
            background: var(--field-green); 
            display: flex; align-items: center; justify-content: center; 
            position: relative; cursor: pointer; user-select: none; 
            aspect-ratio: 1 / 1; 
            overflow: hidden;
        }
        .cell-label { font-size: clamp(6px, 1.5vh, 10px); font-weight: bold; opacity: 0.7; pointer-events: none; }
        .tw { background-color: #b71c1c; .cell-label { color: #fff; } } .dw { background-color: #f57f17; .cell-label { color: #fff; } } 
        .tl { background-color: #0d47a1; .cell-label { color: #fff; } } .dl { background-color: #0288d1; .cell-label { color: #fff; } } 
        .center { background-color: #f57f17; } .star { font-size: 1.5em; color: #fff; padding-bottom: 5px; line-height: 1; }
        
        .tile-look {
            background: linear-gradient(135deg, #fffdf0 0%, #f3e5ab 100%); color: var(--tile-text);
            width: 92%; height: 92%; border-radius: 10%;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.4);
            display: flex; justify-content: center; align-items: center; position: relative; z-index: 10;
        }
        .tile-look.last-move { border: 2px solid #2980b9; box-shadow: 0 0 8px #3498db, inset 0 0 5px #3498db; }
        .tile-letter { font-size: 65%; font-weight: 900; }
        .tile-score { position: absolute; bottom: 8%; right: 10%; font-size: 30%; font-weight: 600; color: #444; }
        .preview .tile-look { opacity: 0.7; box-shadow: none; border: 2px dotted #333; background: #fff; }
        .tile-look.joker .tile-score { display: none; } .tile-look.joker { border: 1px solid #d4af37; }

        /* --- UI CONTAINER --- */
        #ui-container { height: var(--footer-h); width: 100%; max-width: 600px; display: flex; flex-direction: column; gap: 8px; padding: 0 10px 10px 10px; justify-content: flex-end; flex-shrink: 0; }
        #rack { 
            background: linear-gradient(to bottom, var(--wood-dark), var(--wood-light)); padding: 6px 10px 4px 10px;
            border-radius: 8px; display: flex; justify-content: center; gap: 4px; height: 55px; 
            box-shadow: inset 0 3px 6px rgba(0,0,0,0.6); position: relative; opacity: 1 !important; 
        }
        .hand-slot { height: 90%; aspect-ratio: 1/1; display: flex; align-items: flex-end; justify-content: center; cursor: pointer; transition: transform 0.2s; z-index: 2; }
        .hand-slot.selected { transform: translateY(-15px); }
        .hand-slot.swap-selected .tile-look { border: 2px solid #e74c3c; box-shadow: 0 0 10px #e74c3c; }

        #controls { display: grid; grid-template-columns: 1fr 1fr 1fr 1.5fr; gap: 8px; height: 45px; }
        button { font-size: 0.8rem; border: none; border-radius: 8px; font-weight: bold; text-transform: uppercase; cursor: pointer; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.3); box-shadow: 0 3px 0 rgba(0,0,0,0.2); transition: all 0.2s; }
        button:active { transform: translateY(2px); box-shadow: none; }
        button:disabled { background: #95a5a6; cursor: not-allowed; opacity: 0.5; box-shadow: none; transform: none; }
        .btn-pass { background: #7f8c8d; } .btn-swap { background: #3498db; } .btn-reset { background: #e74c3c; } .btn-submit { background: #27ae60; }
        body.swapping .btn-swap { background: #e67e22; animation: pulse 1s infinite; }
        body.swapping .btn-submit { content: 'Tausch best√§tigen'; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

        #msg-overlay { position: fixed; top: 120px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px; font-weight: bold; pointer-events: none; opacity: 0; transition: opacity 0.5s; z-index: 99; }

        /* OVERLAYS */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(3px); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .overlay-box { background: var(--bg-color); padding: 25px; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.7); border: 3px solid var(--ui-gold); width: 90%; max-width: 500px; color: var(--ui-dark); position: relative; max-height: 90vh; overflow-y: auto; }
        .overlay-box h2 { font-family: 'Cinzel', serif; margin-top: 0; border-bottom: 2px solid var(--wood-light); }
        .close-btn { position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--wood-dark); box-shadow: none; }

        /* Joker Picker */
        #joker-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; margin-top: 15px; }
        .joker-btn { background: var(--ui-dark); color: white; padding: 10px; font-weight: bold; border-radius: 4px; box-shadow: none; }
        .joker-btn:hover { background: var(--ui-gold); color: var(--ui-dark); }

        /* Game Over Styles */
        #game-over-box { text-align: center; border-color: #27ae60; background: #fffdf0; }
        .winner-cup { font-size: 3rem; color: #f1c40f; margin-bottom: 10px; animation: bounce 1s infinite; }
        .ranking-list { list-style: none; padding: 0; text-align: left; }
        .ranking-item { padding: 8px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; font-size: 1.1rem; }
        .ranking-item:first-child { font-weight: bold; color: #27ae60; font-size: 1.3rem; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    </style>
</head>
<body>

    <audio id="snd-bgm" src="sounds/bgm.mp3" loop></audio>
    <audio id="snd-plop" src="sounds/plop.mp3"></audio>
    <audio id="snd-error" src="sounds/error.mp3"></audio>
    <audio id="snd-notify" src="sounds/notify.mp3"></audio>
    <audio id="snd-success" src="sounds/success.mp3"></audio>

    <div id="rules-overlay" class="overlay">
        <div class="overlay-box" id="rules-box">
            <button class="close-btn" onclick="toggleRules()">√ó</button>
            <h2>Spielregeln</h2>
            <p>Joker (‚òÖ) k√∂nnen jeden Buchstaben annehmen, bringen aber 0 Punkte.</p>
            <ul>
                <li><strong>Start:</strong> Mitte (Stern).</li>
                <li><strong>Joker:</strong> W√§hle den Buchstaben beim Legen.</li>
                <li><strong>Umlaute:</strong> √Ñ, √ñ, √ú erlaubt. √ü als SS.</li>
                <li><strong>Ende:</strong> Wenn der Beutel leer ist und ein Spieler keine Steine mehr hat.</li>
            </ul>
        </div>
    </div>

    <div id="joker-overlay" class="overlay">
        <div class="overlay-box" style="text-align: center;">
            <h2>Joker w√§hlen</h2>
            <p>Welchen Buchstaben soll der Joker ersetzen?</p>
            <div id="joker-grid"></div>
        </div>
    </div>

    <div id="game-over-overlay" class="overlay">
        <div class="overlay-box" id="game-over-box">
            <div class="winner-cup">üèÜ</div>
            <h2>SPIEL VORBEI!</h2>
            <p>Endstand nach Verrechnung der Reststeine:</p>
            <ul id="ranking-list" class="ranking-list"></ul>
            <button onclick="location.reload()" style="background:#27ae60; margin-top:15px; padding:10px 20px;">Neues Spiel</button>
        </div>
    </div>

    <div id="login-screen">
        <div id="login-box">
            <h2>Scrabble Chef</h2>
            <input type="text" id="inp-room" class="inp" placeholder="Raum (z.B. LOBBY)" value="LOBBY">
            <input type="text" id="inp-name" class="inp" placeholder="Dein Name" maxlength="10">
            <div class="login-buttons">
                <button id="btn-start">Beitreten</button>
                <button id="btn-training">Training (2P)</button>
            </div>
        </div>
    </div>
    
    <div id="scoreboard">
        <button id="btn-rules" onclick="toggleRules()">?</button>
        <button id="btn-music" onclick="toggleMusic()">üîä</button>
        
        <div id="room-display"></div>
        <button id="btn-add-bot" onclick="addBot()">+ BOT</button>
    </div>

    <div id="game-info"></div>
    <div id="msg-overlay"></div>

    <div id="board-wrapper">
        <div id="game-board"></div>
    </div>

    <div id="ui-container">
        <div id="rack"></div>
        <div id="controls">
            <button class="btn-pass" id="btn-pass" onclick="actionPass()">Pass</button>
            <button class="btn-swap" id="btn-swap" onclick="toggleSwapMode()">Tausch</button>
            <button class="btn-reset" id="btn-reset" onclick="resetTurn()">Reset</button>
            <button class="btn-submit" id="btn-submit" onclick="submitAction()">LEGEN</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const scoreboard = document.getElementById('scoreboard');
        const btnAddBot = document.getElementById('btn-add-bot');
        const msgOverlay = document.getElementById('msg-overlay');
        const rackElement = document.getElementById('rack');
        const boardElement = document.getElementById('game-board');
        const btnSubmit = document.getElementById('btn-submit');
        const rulesOverlay = document.getElementById('rules-overlay');
        const jokerOverlay = document.getElementById('joker-overlay');
        const jokerGrid = document.getElementById('joker-grid');
        const gameOverOverlay = document.getElementById('game-over-overlay');
        const rankingList = document.getElementById('ranking-list');
        const roomDisplay = document.getElementById('room-display'); 
        const btnMusic = document.getElementById('btn-music');

        // AUDIO
        const sndBgm = document.getElementById('snd-bgm');
        const sndPlop = document.getElementById('snd-plop');
        const sndError = document.getElementById('snd-error');
        const sndNotify = document.getElementById('snd-notify');
        const sndSuccess = document.getElementById('snd-success');
        sndBgm.volume = 0.3; // Leiser Hintergrund

        let isMusicMuted = localStorage.getItem('scrabble-muted') === 'true';
        updateMusicBtn();

        function toggleMusic() {
            isMusicMuted = !isMusicMuted;
            localStorage.setItem('scrabble-muted', isMusicMuted);
            updateMusicBtn();
            if(isMusicMuted) sndBgm.pause();
            else { 
                // Versuch Musik zu starten (geht nur, wenn User schon interagiert hat)
                sndBgm.play().catch(e => console.log("Auto-play blocked until interact")); 
            }
        }

        function updateMusicBtn() {
            btnMusic.innerText = isMusicMuted ? "üîá" : "üîä";
        }

        function playSound(snd) {
            // SFX immer abspielen, es sei denn wir wollen einen SFX-Mute (hier nur BGM Mute implementiert)
            // Wenn SFX auch gemutet werden sollen: if(isMusicMuted) return;
            try {
                snd.currentTime = 0;
                snd.play().catch(e => {});
            } catch(e) {}
        }
        
        let myHand = []; 
        let currentBoard = Array(225).fill(null);
        let currentTurnMoves = []; 
        let swapSelectedLetters = []; 
        let selectedTile = null; 
        let pendingJokerIndex = null; 
        let lastMoveIndices = []; 

        let myId = null;
        let activePlayerIndex = 0;
        let players = [];
        let isSwapMode = false;
        let isMyTurn = false;

        let titleTimer = null;
        const defaultTitle = "Scrabble Chef";

        function startTitleBlink() {
            if (titleTimer) return;
            let tick = false;
            titleTimer = setInterval(() => {
                document.title = tick ? "üëâ DU BIST DRAN!" : "üîî Deine Runde!";
                tick = !tick;
            }, 1000);
        }

        function stopTitleBlink(keepActiveMsg = false) {
            if (titleTimer) { clearInterval(titleTimer); titleTimer = null; }
            document.title = keepActiveMsg ? "üëâ Du bist dran!" : defaultTitle;
        }

        window.onfocus = () => { if (isMyTurn) stopTitleBlink(true); else stopTitleBlink(false); };
        window.onblur = () => { if (isMyTurn) startTitleBlink(); };

        const LETTER_SCORES = { "A":1,"B":3,"C":4,"D":1,"E":1,"F":4,"G":2,"H":2,"I":1,"J":6,"K":4,"L":2,"M":3,"N":1,"O":2,"P":4,"Q":10,"R":1,"S":1,"T":1,"U":1,"V":6,"W":3,"X":8,"Y":10,"Z":3,"√Ñ":6,"√ñ":8,"√ú":6, "*":0 };
        const ALL_LETTERS = Object.keys(LETTER_SCORES).filter(l => l !== '*');

        ALL_LETTERS.forEach(l => {
            const btn = document.createElement('button');
            btn.className = 'joker-btn';
            btn.innerText = l;
            btn.onclick = () => selectJokerLetter(l);
            jokerGrid.appendChild(btn);
        });

        document.getElementById('btn-start').addEventListener('click', () => {
            const name = document.getElementById('inp-name').value.trim();
            const room = document.getElementById('inp-room').value.trim();
            if(name && room) {
                // Musik starten bei Interaktion
                if(!isMusicMuted) sndBgm.play().catch(e=>console.log(e));
                
                socket.emit('join-game', { name, roomId: room });
                document.getElementById('login-screen').style.display = 'none';
                roomDisplay.innerText = room.toUpperCase(); 
            }
        });

        document.getElementById('btn-training').addEventListener('click', () => {
            // Musik starten bei Interaktion
            if(!isMusicMuted) sndBgm.play().catch(e=>console.log(e));

            socket.emit('join-training');
            document.getElementById('login-screen').style.display = 'none';
            roomDisplay.innerText = "TRAINING"; 
        });

        function toggleRules() { rulesOverlay.style.display = (rulesOverlay.style.display === 'flex') ? 'none' : 'flex'; }
        function addBot() { socket.emit('add-bot'); }
        function showMsg(text) { msgOverlay.innerText = text; msgOverlay.style.opacity = 1; setTimeout(() => msgOverlay.style.opacity = 0, 3000); }
        
        function createTileHTML(letter, isJokerDisplay = false, scoreVal = null, isLastMove = false) {
            let displayLetter = letter;
            let displayScore = scoreVal !== null ? scoreVal : (LETTER_SCORES[letter] || 0);
            if (letter === '*') displayLetter = ''; 
            let classes = "tile-look";
            if (isJokerDisplay || letter === '*' || scoreVal === 0) classes += " joker";
            if (isLastMove) classes += " last-move";
            return `<div class="${classes}"><span class="tile-letter">${displayLetter}</span><span class="tile-score">${displayScore}</span></div>`;
        }

        function getCellType(i) {
            const x = i % 15; const y = Math.floor(i / 15); const k = x+","+y;
            if (k==="7,7") return "center";
            if ((x===0||x===7||x===14)&&(y===0||y===7||y===14)&&k!=="7,7") return "tw";
            if (x===y||x+y===14) { if(x>=1&&x<=4) return "dw"; if(x>=10&&x<=13) return "dw"; }
            if ((x===5||x===9)&&(y===1||y===5||y===9||y===13)) return "tl";
            if ((y===5||y===9)&&(x===1||x===5||x===9||x===13)) return "tl";
            if ((x===3||x===11)&&(y===0||y===7||y===14)) return "dl";
            if ((y===3||y===11)&&(x===0||x===7||x===14)) return "dl";
            if ((x===2||x===6||x===8||x===12)&&(y===6||y===8)) return "dl";
            if ((y===2||y===6||y===8||y===12)&&(x===6||x===8)) return "dl";
            return "";
        }

        function updateUI() {
            const badges = [];
            players.forEach((p, idx) => {
                const isActive = idx === activePlayerIndex;
                const isMe = p.id === myId;
                const badge = document.createElement('div');
                badge.className = `player-badge ${isActive ? 'active-turn' : ''}`;
                badge.innerHTML = `<span class="p-name">${p.name}${isMe?' (DU)':''}</span><span class="p-score">${p.score}</span>`;
                badges.push(badge);
            });
            
            const btnRules = document.getElementById('btn-rules'); 
            const btnBot = document.getElementById('btn-add-bot'); 
            scoreboard.innerHTML = '';
            scoreboard.appendChild(btnRules); 
            scoreboard.appendChild(btnMusic); // Musik Button
            scoreboard.appendChild(roomDisplay); 
            badges.forEach(b => scoreboard.appendChild(b)); 
            scoreboard.appendChild(btnBot); 

            const wasMyTurn = isMyTurn;
            isMyTurn = (players[activePlayerIndex]?.id === myId);
            
            // Notification Sound nur wenn Zug wechselt zu mir
            if (isMyTurn && !wasMyTurn) playSound(sndNotify);

            if (isMyTurn) {
                if (!document.hasFocus()) startTitleBlink();
                else document.title = "üëâ Du bist dran!";
            } else {
                stopTitleBlink(false);
            }

            if (players.length < 4 && !players[0].name.includes("ICH")) btnBot.style.display = 'block'; else btnBot.style.display = 'none';

            const btns = document.querySelectorAll('#controls button');
            btns.forEach(b => b.disabled = !isMyTurn);
            btnSubmit.innerText = isSwapMode ? "BEST√ÑTIGEN" : "LEGEN";
            
            renderBoard();
            renderHand();
        }

        function renderBoard() {
            boardElement.innerHTML = '';
            for (let i = 0; i < 225; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell ' + getCellType(i);
                if(!currentBoard[i]) {
                    const type = getCellType(i); let txt = "";
                    if(type==='tw') txt="3W"; if(type==='dw') txt="2W"; if(type==='tl') txt="3B"; if(type==='dl') txt="2B";
                    if(type==='center') cell.innerHTML = '<span class="star">‚òÖ</span>'; else if(txt) cell.innerHTML = `<span class="cell-label">${txt}</span>`;
                }
                const isLastMove = lastMoveIndices.includes(i);
                if (currentBoard[i]) { 
                    const tileData = currentBoard[i];
                    cell.innerHTML = createTileHTML(tileData.l, tileData.v === 0, tileData.v, isLastMove); 
                } 
                else {
                    const localMove = currentTurnMoves.find(m => m.index === i);
                    if (localMove) { 
                        cell.innerHTML = createTileHTML(localMove.letter, localMove.isJoker, localMove.isJoker ? 0 : null, false); 
                        cell.classList.add('preview'); 
                    }
                }
                cell.onclick = () => handleBoardClick(i);
                boardElement.appendChild(cell);
            }
        }

        function renderHand() {
            rackElement.innerHTML = '';
            myHand.forEach((letter, idx) => {
                const slot = document.createElement('div');
                slot.className = 'hand-slot';
                const isPlaced = currentTurnMoves.some(m => m.handIndex === idx); 
                if (isSwapMode) { if (swapSelectedLetters.includes(idx)) slot.classList.add('swap-selected'); } 
                else { if (selectedTile && selectedTile.handIndex === idx) slot.classList.add('selected'); }
                if (!isPlaced) { 
                    slot.innerHTML = createTileHTML(letter); 
                    slot.onclick = () => handleHandClick(letter, idx);
                }
                rackElement.appendChild(slot);
            });
        }

        function handleHandClick(letter, idx) {
            // Sound beim Klicken
            playSound(sndPlop);

            if (isSwapMode) {
                if(!isMyTurn) return; 
                if (swapSelectedLetters.includes(idx)) swapSelectedLetters = swapSelectedLetters.filter(i => i !== idx); else swapSelectedLetters.push(idx);
                renderHand(); return;
            }
            if (selectedTile) {
                if (selectedTile.handIndex !== idx) {
                    const temp = myHand[selectedTile.handIndex]; myHand[selectedTile.handIndex] = myHand[idx]; myHand[idx] = temp;
                    selectedTile = null; renderHand(); return; 
                } else selectedTile = null;
            } else selectedTile = { letter, handIndex: idx };
            renderHand();
        }

        function handleBoardClick(index) {
            if (!isMyTurn || isSwapMode) return;
            const existingMoveIdx = currentTurnMoves.findIndex(m => m.index === index);
            
            // Stein zur√ºcknehmen
            if (existingMoveIdx !== -1) { 
                playSound(sndPlop);
                currentTurnMoves.splice(existingMoveIdx, 1); 
                selectedTile = null; renderBoard(); renderHand(); return; 
            }
            
            // Stein legen
            if (selectedTile && !currentBoard[index]) {
                playSound(sndPlop);
                if (selectedTile.letter === '*') {
                    pendingJokerIndex = index;
                    jokerOverlay.style.display = 'flex';
                } else {
                    currentTurnMoves.push({ index: index, letter: selectedTile.letter, handIndex: selectedTile.handIndex, isJoker: false });
                    selectedTile = null; renderBoard(); renderHand();
                }
            }
        }

        function selectJokerLetter(char) {
            if (pendingJokerIndex !== null && selectedTile) {
                playSound(sndPlop);
                currentTurnMoves.push({ index: pendingJokerIndex, letter: char, handIndex: selectedTile.handIndex, isJoker: true });
                pendingJokerIndex = null; selectedTile = null; jokerOverlay.style.display = 'none'; renderBoard(); renderHand();
            }
        }

        function toggleSwapMode() {
            if (currentTurnMoves.length > 0) resetTurn(); 
            isSwapMode = !isSwapMode; swapSelectedLetters = [];
            document.body.classList.toggle('swapping', isSwapMode); updateUI();
        }

        function resetTurn() {
            currentTurnMoves = []; selectedTile = null; swapSelectedLetters = [];
            isSwapMode = false; document.body.classList.remove('swapping'); updateUI();
        }

        function actionPass() { if(confirm("Passen?")) { resetTurn(); socket.emit('action-pass'); } }

        function submitAction() {
            if (isSwapMode) {
                if (swapSelectedLetters.length === 0) return;
                const letters = swapSelectedLetters.map(idx => myHand[idx]); socket.emit('action-swap', letters); resetTurn();
            } else {
                if (currentTurnMoves.length === 0) return;
                const movesToSend = currentTurnMoves.map(m => ({ index: m.index, letter: m.letter, isJoker: m.isJoker }));
                socket.emit('action-place', movesToSend);
            }
        }

        socket.on('update-game-state', (state) => {
            currentBoard = state.board; 
            players = state.players; 
            activePlayerIndex = state.activePlayerIndex; 
            myId = socket.id;
            lastMoveIndices = state.lastMoveIndices || []; 
            currentTurnMoves = []; isSwapMode = false; document.body.classList.remove('swapping'); updateUI();
        });
        socket.on('update-hand', (hand) => { myHand = hand; renderHand(); });
        
        socket.on('error-msg', (msg) => { 
            playSound(sndError);
            showMsg("‚ö†Ô∏è " + msg); 
        });
        
        socket.on('game-msg', (text) => {
            // Wenn "legt" oder "tauscht" im Text vorkommt, war es ein erfolgreicher Zug
            // (Wir filtern, um nicht bei jedem kleinen Status-Update zu bimmeln)
            if (text.includes("legt") || text.includes("tauscht")) {
                 playSound(sndSuccess);
            }
            showMsg(text);
        });
        
        socket.on('game-over', (data) => {
            playSound(sndSuccess); // Fanfare am Ende
            stopTitleBlink(false);
            const { rankedPlayers } = data;
            rankingList.innerHTML = '';
            rankedPlayers.forEach((p, index) => {
                const li = document.createElement('li');
                li.className = 'ranking-item';
                li.innerHTML = `<span>${index + 1}. ${p.name}</span><span>${p.score} Pkt</span>`;
                rankingList.appendChild(li);
            });
            gameOverOverlay.style.display = 'flex';
        });
    </script>
</body>
</html>
