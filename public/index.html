<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scrabble Chef Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@500;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1a1a1a;
            --board-border: #4e342e; /* Dunkler Holzrahmen */
            --grid-gap: #111; /* Die Linien zwischen den Feldern */
            --field-green: #2e7d32; /* Sattes Filz-Grün */
            --tile-color: #f3e5ab; /* Elfenbein/Holz */
            --tile-text: #2c3e50;
        }

        * { box-sizing: border-box; }

        body { 
            font-family: 'Roboto', sans-serif; 
            background: var(--bg-color); 
            color: #ecf0f1; 
            margin: 0; 
            padding: 10px;
            /* Perfekte Zentrierung */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        /* Container für das Spielbrett (Rahmen) */
        #board-wrapper {
            background: var(--board-border);
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.6);
            /* Maximale Breite, aber passt sich an */
            width: 100%;
            max-width: 600px; 
            /* Erhält das Quadrat-Format */
            aspect-ratio: 1 / 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Das eigentliche Gitter */
        #game-board { 
            display: grid; 
            /* Exakt 15 Spalten */
            grid-template-columns: repeat(15, 1fr); 
            grid-template-rows: repeat(15, 1fr);
            gap: 2px; /* Die gleichmäßigen Linien */
            background: var(--grid-gap); 
            width: 100%;
            height: 100%;
            border: 2px solid var(--grid-gap);
        }

        .cell { 
            background: var(--field-green); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            position: relative;
            cursor: pointer; 
            user-select: none;
            overflow: hidden; /* Damit nichts übersteht */
        }
        
        /* Labels auf dem Brett (3W, 2B etc.) */
        .cell-label {
            font-size: clamp(6px, 1.5vw, 10px);
            font-weight: bold;
            opacity: 0.7;
            text-align: center;
        }

        /* Spezialfelder Farben */
        .tw { background-color: #b71c1c; .cell-label { color: #fff; } } /* 3W Rot */
        .dw { background-color: #f57f17; .cell-label { color: #fff; } } /* 2W Orange */
        .tl { background-color: #0d47a1; .cell-label { color: #fff; } } /* 3B Dunkelblau */
        .dl { background-color: #0288d1; .cell-label { color: #fff; } } /* 2B Hellblau */
        .center { background-color: #f57f17; display: flex; align-items: center; justify-content: center; }
        .star { font-size: 20px; color: #fff; }

        /* --- Der Spielstein --- */
        .tile-look {
            background: linear-gradient(135deg, #fff8e1 0%, #f3e5ab 100%);
            color: var(--tile-text);
            width: 95%; height: 95%;
            border-radius: 3px;
            box-shadow: 1px 1px 2px rgba(0,0,0,0.4);
            display: flex; 
            justify-content: center; 
            align-items: center;
            position: relative;
            z-index: 10;
        }
        
        .tile-letter {
            font-size: clamp(10px, 3.5vw, 22px);
            font-weight: 900;
            transform: translateY(-5%); /* Leicht nach oben für Platz für Zahl */
        }

        .tile-score {
            position: absolute;
            bottom: 2px;
            right: 3px;
            font-size: clamp(5px, 1.2vw, 9px);
            font-weight: 500;
            color: #555;
        }
        
        .preview .tile-look {
            opacity: 0.7; /* Vorschau leicht transparent */
            box-shadow: none;
        }

        /* --- UI Controls unten --- */
        #ui-container {
            width: 100%;
            max-width: 600px;
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        #rack { 
            background: #263238; 
            padding: 10px; 
            border-radius: 8px; 
            display: flex; 
            justify-content: center; 
            gap: 5px;
            min-height: 50px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
        }
        
        .hand-slot {
            width: clamp(30px, 13vw, 45px);
            height: clamp(30px, 13vw, 45px);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            transition: transform 0.1s;
        }
        
        .hand-slot.selected { transform: translateY(-10px); }

        #controls { display: flex; justify-content: space-between; gap: 10px; }
        
        button { 
            flex: 1;
            padding: 15px; 
            font-size: 16px; 
            border: none; border-radius: 4px; 
            font-weight: bold; text-transform: uppercase; letter-spacing: 1px;
            cursor: pointer;
        }
        .btn-submit { background-color: #388e3c; color: white; box-shadow: 0 4px 0 #1b5e20; }
        .btn-submit:active { transform: translateY(4px); box-shadow: none; }
        
        .btn-reset { background-color: #d32f2f; color: white; box-shadow: 0 4px 0 #8c1b1b; }
        .btn-reset:active { transform: translateY(4px); box-shadow: none; }

        #status { text-align: center; color: #ffb300; font-weight: bold; height: 20px; margin-bottom: 5px;}

    </style>
</head>
<body>
    
    <div id="status">Verbinde...</div>

    <div id="board-wrapper">
        <div id="game-board"></div>
    </div>

    <div id="ui-container">
        <div id="rack"></div>
        <div id="controls">
            <button class="btn-reset" onclick="resetTurn()">Löschen</button>
            <button class="btn-submit" onclick="submitTurn()">Legen</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const boardElement = document.getElementById('game-board');
        const rackElement = document.getElementById('rack');
        const statusElement = document.getElementById('status');
        
        let selectedTile = null; 
        let myHand = []; 
        let currentBoard = Array(225).fill(null);
        let currentTurnMoves = []; 

        // Punktewerte für die Anzeige (Deutsch)
        const LETTER_SCORES = {
            "A": 1, "B": 3, "C": 4, "D": 1, "E": 1, "F": 4, "G": 2, "H": 2, 
            "I": 1, "J": 6, "K": 4, "L": 2, "M": 3, "N": 1, "O": 2, "P": 4, 
            "Q": 10, "R": 1, "S": 1, "T": 1, "U": 1, "V": 6, "W": 3, "X": 8, 
            "Y": 10, "Z": 3, "?": 0
        };

        function getCellType(x, y) {
            const k = x + "," + y;
            if (k === "7,7") return "center";
            // Triple Word (3W) - Ecken und Mitten der Ränder
            if ((x===0||x===7||x===14) && (y===0||y===7||y===14) && k!=="7,7") return "tw"; 
            // Double Word (2W) - Diagonalen
            if (x===y || x+y===14) {
                 if(x>=1 && x<=4) return "dw"; 
                 if(x>=10 && x<=13) return "dw"; 
            }
            // Triple Letter (3B)
            if ((x===5||x===9) && (y===1||y===5||y===9||y===13)) return "tl";
            if ((y===5||y===9) && (x===1||x===5||x===9||x===13)) return "tl";
            // Double Letter (2B)
            if ((x===3||x===11) && (y===0||y===7||y===14)) return "dl";
            if ((y===3||y===11) && (x===0||x===7||x===14)) return "dl";
            if ((x===2||x===6||x===8||x===12) && (y===6||y===8)) return "dl";
            if ((y===2||y===6||y===8||y===12) && (x===6||x===8)) return "dl";
            
            return "";
        }

        // --- HTML Generator für einen Spielstein ---
        function createTileHTML(letter) {
            const score = LETTER_SCORES[letter] !== undefined ? LETTER_SCORES[letter] : 0;
            return `
                <div class="tile-look">
                    <span class="tile-letter">${letter}</span>
                    <span class="tile-score">${score}</span>
                </div>
            `;
        }

        // Brett initialisieren
        for (let i = 0; i < 225; i++) {
            const cell = document.createElement('div');
            cell.classList.add('cell');
            const x = i % 15; const y = Math.floor(i / 15);
            const type = getCellType(x, y);
            
            if(type) cell.classList.add(type);
            
            // Labels rendern (wenn kein Stein drauf ist)
            let labelText = "";
            if(type === 'tw') labelText = "3W";
            else if(type === 'dw') labelText = "2W";
            else if(type === 'tl') labelText = "3B";
            else if(type === 'dl') labelText = "2B";
            
            if (type === 'center') {
                cell.innerHTML = '<span class="star">★</span>';
            } else if (labelText) {
                cell.innerHTML = `<span class="cell-label">${labelText}</span>`;
            }

            cell.dataset.index = i;
            
            cell.addEventListener('click', () => {
                const isOccupiedServer = currentBoard[i] !== null;
                const isOccupiedLocal = currentTurnMoves.find(m => m.index === i);

                if (!isOccupiedServer && !isOccupiedLocal && selectedTile) {
                    // Inhalt überschreiben
                    cell.innerHTML = createTileHTML(selectedTile.letter);
                    cell.classList.add('preview');
                    
                    currentTurnMoves.push({ index: i, letter: selectedTile.letter });
                    myHand.splice(selectedTile.handIndex, 1);
                    selectedTile = null;
                    renderHand();
                }
            });
            boardElement.appendChild(cell);
        }

        function renderHand() {
            rackElement.innerHTML = '';
            myHand.forEach((letter, idx) => {
                const slot = document.createElement('div');
                slot.classList.add('hand-slot');
                slot.innerHTML = createTileHTML(letter);
                
                slot.addEventListener('click', () => {
                    document.querySelectorAll('.hand-slot').forEach(t => t.classList.remove('selected'));
                    slot.classList.add('selected');
                    selectedTile = { letter: letter, handIndex: idx };
                });
                rackElement.appendChild(slot);
            });
        }

        function resetTurn() {
            currentTurnMoves.forEach(move => myHand.push(move.letter));
            currentTurnMoves = [];
            renderHand();
            updateBoardView(); 
        }

        function submitTurn() {
            if (currentTurnMoves.length === 0) return;
            socket.emit('submit-turn', currentTurnMoves);
        }

        function updateBoardView() {
            const cells = document.querySelectorAll('.cell');
            cells.forEach((cell, i) => {
                const x = i % 15; const y = Math.floor(i / 15);
                const type = getCellType(x, y);
                
                // Grundzustand wiederherstellen
                cell.className = 'cell'; 
                if(type) cell.classList.add(type);

                if (currentBoard[i]) {
                    // Fester Stein
                    cell.innerHTML = createTileHTML(currentBoard[i]);
                } else {
                    // Label wiederherstellen
                    let labelText = "";
                    if(type === 'tw') labelText = "3W";
                    else if(type === 'dw') labelText = "2W";
                    else if(type === 'tl') labelText = "3B";
                    else if(type === 'dl') labelText = "2B";
                    
                    if (type === 'center') cell.innerHTML = '<span class="star">★</span>';
                    else if (labelText) cell.innerHTML = `<span class="cell-label">${labelText}</span>`;
                    else cell.innerHTML = '';
                }
            });
        }

        // --- Socket ---
        socket.on('player-assignment', (data) => statusElement.innerText = `Spieler ${data.playerIndex + 1}`);
        socket.on('update-hand', (newHand) => { myHand = newHand; renderHand(); });
        socket.on('move-error', (msg) => {
            const oldT = statusElement.innerText;
            statusElement.innerText = msg;
            statusElement.style.color = "#ff5252";
            setTimeout(() => { statusElement.innerText = oldT; statusElement.style.color = "#ffb300"; }, 3000);
            resetTurn(); 
        });
        socket.on('update-board', (boardData) => {
            currentBoard = boardData;
            currentTurnMoves = [];
            updateBoardView();
        });
    </script>
</body>
</html>
